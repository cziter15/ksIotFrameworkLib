## StopTheWar
I've recently switched to PlatformIO as base endpoint for this library and I'm super-happy with this. Amazing support, amazing epxierence! I really loved PlatformIO. PlatformIO is a Ukrainian project, so I've decided to link their message here...

https://community.platformio.org/t/platformio-is-a-ukrainian-project-please-help-us-stop-the-war/26330

# ksIotFrameworkLib
[![Build for PlatformIO](https://img.shields.io/badge/works%20best%20with-PlatformIO-orange?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMjUwMCIgaGVpZ2h0PSIyNTAwIiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCI+PHBhdGggZD0iTTEyOCAwQzkzLjgxIDAgNjEuNjY2IDEzLjMxNCAzNy40OSAzNy40OSAxMy4zMTQgNjEuNjY2IDAgOTMuODEgMCAxMjhjMCAzNC4xOSAxMy4zMTQgNjYuMzM0IDM3LjQ5IDkwLjUxQzYxLjY2NiAyNDIuNjg2IDkzLjgxIDI1NiAxMjggMjU2YzM0LjE5IDAgNjYuMzM0LTEzLjMxNCA5MC41MS0zNy40OUMyNDIuNjg2IDE5NC4zMzQgMjU2IDE2Mi4xOSAyNTYgMTI4YzAtMzQuMTktMTMuMzE0LTY2LjMzNC0zNy40OS05MC41MUMxOTQuMzM0IDEzLjMxNCAxNjIuMTkgMCAxMjggMCIgZmlsbD0iI0ZGN0YwMCIvPjxwYXRoIGQ9Ik0yNDkuMzg2IDEyOGMwIDY3LjA0LTU0LjM0NyAxMjEuMzg2LTEyMS4zODYgMTIxLjM4NkM2MC45NiAyNDkuMzg2IDYuNjEzIDE5NS4wNCA2LjYxMyAxMjggNi42MTMgNjAuOTYgNjAuOTYgNi42MTQgMTI4IDYuNjE0YzY3LjA0IDAgMTIxLjM4NiA1NC4zNDYgMTIxLjM4NiAxMjEuMzg2IiBmaWxsPSIjRkZGIi8+PHBhdGggZD0iTTE2MC44NjkgNzQuMDYybDUuMTQ1LTE4LjUzN2M1LjI2NC0uNDcgOS4zOTItNC44ODYgOS4zOTItMTAuMjczIDAtNS43LTQuNjItMTAuMzItMTAuMzItMTAuMzJzLTEwLjMyIDQuNjItMTAuMzIgMTAuMzJjMCAzLjc1NSAyLjAxMyA3LjAzIDUuMDEgOC44MzdsLTUuMDUgMTguMTk1Yy0xNC40MzctMy42Ny0yNi42MjUtMy4zOS0yNi42MjUtMy4zOWwtMi4yNTggMS4wMXYxNDAuODcybDIuMjU4Ljc1M2MxMy42MTQgMCA3My4xNzctNDEuMTMzIDczLjMyMy04NS4yNyAwLTMxLjYyNC0yMS4wMjMtNDUuODI1LTQwLjU1NS01Mi4xOTd6TTE0Ni41MyAxNjQuOGMtMTEuNjE3LTE4LjU1Ny02LjcwNi02MS43NTEgMjMuNjQzLTY3LjkyNSA4LjMyLTEuMzMzIDE4LjUwOSA0LjEzNCAyMS41MSAxNi4yNzkgNy41ODIgMjUuNzY2LTM3LjAxNSA2MS44NDUtNDUuMTUzIDUxLjY0NnptMTguMjE2LTM5Ljc1MmE5LjM5OSA5LjM5OSAwIDAgMC05LjM5OSA5LjM5OSA5LjM5OSA5LjM5OSAwIDAgMCA5LjQgOS4zOTkgOS4zOTkgOS4zOTkgMCAwIDAgOS4zOTgtOS40IDkuMzk5IDkuMzk5IDAgMCAwLTkuMzk5LTkuMzk4em0yLjgxIDguNjcyYTIuMzc0IDIuMzc0IDAgMSAxIDAtNC43NDkgMi4zNzQgMi4zNzQgMCAwIDEgMCA0Ljc0OXoiIGZpbGw9IiNFNTcyMDAiLz48cGF0aCBkPSJNMTAxLjM3MSA3Mi43MDlsLTUuMDIzLTE4LjkwMWMyLjg3NC0xLjgzMiA0Ljc4Ni01LjA0IDQuNzg2LTguNzAxIDAtNS43LTQuNjItMTAuMzItMTAuMzItMTAuMzItNS42OTkgMC0xMC4zMTkgNC42Mi0xMC4zMTkgMTAuMzIgMCA1LjY4MiA0LjU5MiAxMC4yODkgMTAuMjY3IDEwLjMxN0w5NS44IDc0LjM3OGMtMTkuNjA5IDYuNTEtNDAuODg1IDIwLjc0Mi00MC44ODUgNTEuODguNDM2IDQ1LjAxIDU5LjU3MiA4NS4yNjcgNzMuMTg2IDg1LjI2N1Y2OC44OTJzLTEyLjI1Mi0uMDYyLTI2LjcyOSAzLjgxN3ptMTAuMzk1IDkyLjA5Yy04LjEzOCAxMC4yLTUyLjczNS0yNS44OC00NS4xNTQtNTEuNjQ1IDMuMDAyLTEyLjE0NSAxMy4xOS0xNy42MTIgMjEuNTExLTE2LjI4IDMwLjM1IDYuMTc1IDM1LjI2IDQ5LjM2OSAyMy42NDMgNjcuOTI2em0tMTguODItMzkuNDZhOS4zOTkgOS4zOTkgMCAwIDAtOS4zOTkgOS4zOTggOS4zOTkgOS4zOTkgMCAwIDAgOS40IDkuNCA5LjM5OSA5LjM5OSAwIDAgMCA5LjM5OC05LjQgOS4zOTkgOS4zOTkgMCAwIDAtOS4zOTktOS4zOTl6bS0yLjgxIDguNjcxYTIuMzc0IDIuMzc0IDAgMSAxIDAtNC43NDggMi4zNzQgMi4zNzQgMCAwIDEgMCA0Ljc0OHoiIGZpbGw9IiNGRjdGMDAiLz48L3N2Zz4=)](https://platformio.org)
[![Hits-of-Code](https://hitsofcode.com/github/cziter15/ksIotFrameworkLib)](https://hitsofcode.com/github/cziter15/ksIotFrameworkLib/view)
[![Commit activity](https://img.shields.io/github/commit-activity/m/cziter15/ksIotFrameworkLib)](https://github.com/cziter15/ksIotFrameworkLib/commits/master)
[![License](https://img.shields.io/github/license/cziter15/ksIotFrameworkLib)](https://github.com/cziter15/ksIotFrameworkLib/blob/master/LICENSE)

<p align="center">
  <img src="doc/header.jpg">
</p>

## What and why?

The goal of this project is to create a simple template or starting point for developing Internet of Things (IoT) applications using the ESP 8266/32 microcontroller. I noticed that I was frequently copying and modifying existing applications when creating new ones for different devices, and I wanted to streamline this process. This project aims to do just that by providing a more organized approach to starting new IoT projects with the ESP 8266/32.

## Architecture
<p align="center">
  <img src="doc/app_diagram.png">
</p>

- The user can define and execute one application at a time.
- Each application consists of components.
- Each application has three methods that iterate over the components: init, postInit, and loop.
- The init method is called during component initialization (after construction).
- The postInit method is called after component initialization. It is typically used to obtain a weak pointer to another component.
- The loop method is called during each iteration of the application loop.
- The init and loop methods can cause the application to exit prematurely. If either method returns false, it will cause the main application loop to terminate and the next application to be executed (e.g. the config application).

## Utilities
| Utility  | Function |
| ------------- | ------------- |
| ksEvent  | Provides a simple event broadcasting system. Used for MQTT events, etc. |
| ksSimpleTimer  | A very simple "timer" mechanism. In the triggered() method, it calculates and checks if the specified interval has just passed. |
| ksSafeList  | A safe list for manipulating items while iterating over them. Contains three underlying lists: pending to add, pending to remove, and the actual item list. Call **add** or **remove** while iterating and then call **applyPendingOperations**. The component system relies on this mechanism. |

## Components
| Component  | Function |
| ------------- | ------------- |
| ksConfigProvider  |Used to manage parameters. The configurator component calls each config provider to handle parameter injection/capture during the WiFi configuration stage. |
| ksLed  | Used to control diodes, including blinking, turning off, and turning on. |
| ksMqttConfigProvider  | Used to manage MQTT parameters (broker, password, prefix, etc.). |
| ksMqttConnector  | Used to maintain a connection with MQTT. The user can bind to the onMessage and onConnected events. |
| ksMqttDebugResponder  | Provides debug commands for apps using the ksMqttConnector component. |
| ksOtaUpdater  | Configures and handles over-the-air (OTA) update functionality. |
| ksResetButton  | Used to exit the app loop or reset the entire device (to trigger the config portal). |
| ksWiFiConfigurator | The base WiFi configurator component, providing WiFi management portal and allowing config providers to inject and capture parameters. |
| ksWiFiConnector | Manages WiFi connection (triggers events, handles reconnection etc.). |

### Rules:
- Components can only be added in the app's **init** method, before calling the **base init** method.
- The **findComponent** method **must not** be called from component **init** methods.
- The **postInit** method is the best place to obtain a weak pointer to another component by calling **findComponent**.
- Currently, dynamic component creation (from outside the **init** method) is not supported.

## Building application
To build an application, simply create a new class inherited from ksApplication. Inside the init method, add and set up components, then call the base ksApplication's init method. You can also optionally override the loop method, but remember that the base class method (ksApplication's loop) iterates over the list of registered components and executes the loop call on each of them.

## A word of warning
The idea was to prevent launching the application if any component initialization fails. This will cause the ksApplication::init (base class) method to return false, but due to inheritance, the user can override this behavior. The application will then try to launch and, after initialization, it will tick every component, even if one of them failed to initialize. This can result in crashes, especially in the loop method.

**Do not add components inside loop() method. To destroy component, please use **markComponentToRemove** method.

### The flow is as follows:
- Add components (addComponent simply constructs a class and adds its pointer to the app component list).
- Run ksApplication::init (it will iterate through the component list and initialize them, returning false if any initialization fails).
- If ksApplication::init() does not return true, simply return false in your app's init method.

```c++
bool EnergyMonitor::init()
{
	/* Add WiFi connector component. */
	addComponent<ksf::comps::ksWifiConnector>(apps::config::EnergyMonitorConfig::emonDeviceName);

	/* Add MQTT components. */
	addComponent<ksf::comps::ksMqttDebugResponder>();
	mqttWp = addComponent<ksf::comps::ksMqttConnector>();

	/* Add LED indicator components. */
	statusLedWp = addComponent<ksf::comps::ksLed>(STATUS_LED_PIN);
	eventLedWp = addComponent<ksf::comps::ksLed>(EVENT_LED_PIN);

	/* Create OTA component. */
	addComponent<ksf::comps::ksOtaUpdater>();

	/* Add sensor component. */
	auto sensorCompWp{addComponent<components::EnergySensor>(ANA_PIN)};

	/* Setup reset button. */
	addComponent<ksf::comps::ksResetButton>(CFG_PUSH_PIN, LOW);

	if (!ksApplication::init())
		return false;

	/* [ Rest of application initialization code ] */

	return true;
}
```

## Compiler flags
Bare Arduino projects need to have C++17 enabled via `compiler.cpp.extra_flags=` option in the board.txt file.

## Custom RTTI
Use the KSF_RTTI_DECLARATIONS macro to provide proper runtime type information generation for proper casting of components. 
See ksConfigProvider.h for an example. Your application components should use this macro, otherwise the component finding mechanism won't work.

## Saving power
By default, this framework supports power saving for the modem. This requires the DTIM to be set on the access point. 
The best value for me is 3. It allows the ESP32 to go down from around 100mA to 20mA.

## Dependencies
**It is highly recommended to use PlatformIO as it will automatically download dependencies!**

### Frameworks
- Arduino for ESP32 [ https://github.com/espressif/arduino-esp32 ]
- Arduino for ESP8266 [ https://github.com/esp8266/Arduino ]

### Libraries
- WiFiManager [ https://github.com/tzapu/WiFiManager ]
- PubSubClient [ https://github.com/knolleary/pubsubclient ]

## Donate
Feel free to support development (of course optionally) :)

[<img src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif">](https://www.paypal.com/donate/?hosted_button_id=A3QTXX6MN9LN8)
