<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Doxygen with github: ksIotFrameworkLib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Doxygen with github
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ksIotFrameworkLib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a></p>
<blockquote class="doxtable">
<p>&zwj;Arduino Library for ESP32/ESP8266 - a composition-oriented Internet of Things framework that provides a simple and extendable architecture, handles device setup (WiFi setup, MQTT and application-specific configuration), network connectivity, MQTT telemetry protocol, and more... </p>
</blockquote>
<p><a href="https://cziter15.github.io/ksIotFrameworkLib"><img src="https://img.shields.io/badge/Doxygen-2C4AA8?logo=doxygen&amp;style=for-the-badge" alt="Read the documentation" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/blob/master/LICENSE"><img src="https://img.shields.io/github/license/cziter15/ksIotFrameworkLib?style=for-the-badge" alt="License" class="inline"/></a></p>
<p><a href="https://app.codacy.com/gh/cziter15/ksIotFrameworkLib/dashboard?utm_source=gh&amp;utm_medium=referral&amp;utm_content=&amp;utm_campaign=Badge_grade"><img src="https://app.codacy.com/project/badge/Grade/956910bb43464108883bdcf57b1f6943" alt="Codacy Badge" class="inline"/></a> <a href="https://github.com/cziter15/ksiotframeworklib"><img src="https://img.shields.io/endpoint?color=blue&amp;url=https%3A%2F%2Fghloc.vercel.app%2Fapi%2Fcziter15%2Fksiotframeworklib%2Fbadge%3Ffilter%3D.hpp%24%2C.cpp%24%2C.h%24%26label%3DLines%2520of%2520Code" alt="Lines of Code" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/commits/master"><img src="https://img.shields.io/github/commit-activity/m/cziter15/ksIotFrameworkLib" alt="Commit activity" class="inline"/></a> <a href="https://platformio.org"><img src="https://img.shields.io/badge/powered%20by-platformio-orange?logo=platformio" alt="Powered by platformio" class="inline"/></a> <a href="https://github.com/pioarduino"><img src="https://img.shields.io/badge/powered%20by-pioarduino-orange?logo=pioarduino&amp;color=darkgreen" alt="Powered by pioarduino" class="inline"/></a></p>
<p><img src="https://github.com/cziter15/ksIotFrameworkLib/assets/5003708/a17e4fe9-144c-4422-be40-90e0f402b054" alt="image" class="inline"/></p>
<blockquote class="doxtable">
<p>&zwj;<b>IMPORTANT FOR ESP32</b></p>
<p>This library targets Arduino 3+ on ESP32. Due to <a href="https://github.com/platformio/platform-espressif32/issues/1225">PlatformIO limitations</a>, it does not automatically fetch the latest versions. Use the pioarduino fork by Jason2866 in your <code>platformio.ini</code> file: </p><div class="fragment"><div class="line">platform = https://github.com/pioarduino/platform-espressif32.git</div>
</div><!-- fragment --> </blockquote>
<blockquote class="doxtable">
<p>&zwj;<b>IMPORTANT FOR ESP8266</b></p>
<p>For ESP8266, the latest supported version is based on SDK305. To use it, please add this build flag: </p><div class="fragment"><div class="line">DPIO_FRAMEWORK_ARDUINO_ESPRESSIF_SDK305</div>
<div class="line">&gt;</div>
</div><!-- fragment --> </blockquote>
<h1><a class="anchor" id="autotoc_md1"></a>
üìú Motivation</h1>
<ul>
<li>The goal of this project is to create a simple template or starting point for developing IMotivationoT applications using Espressif microcontrollers.</li>
<li>This project aims to streamline the process of copying and modifying source code for different devices.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
üìö Documentation</h1>
<ul>
<li>Detailed documentation can be found <a href="https://cziter15.github.io/ksIotFrameworkLib">here</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Examples</h1>
<ul>
<li>For examples, refer to the <a href="https://github.com/cziter15/ksIotFrameworkLib/tree/master/examples">examples directory</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
üõ†Ô∏è Architecture</h1>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    AppState{AppState}</div>
<div class="line">    AppState --&gt; |NotInitialized| Application::Init</div>
<div class="line">    AppState --&gt; |Initialized| Application::Loop</div>
<div class="line"> </div>
<div class="line">    subgraph Application::Init</div>
<div class="line">        A(Add initial components) --&gt; B(Mark app state as initialized)</div>
<div class="line">    end</div>
<div class="line">   </div>
<div class="line">    subgraph Application::Loop</div>
<div class="line">        Loop{{For each component}} --&gt; CCS{State?}</div>
<div class="line"> </div>
<div class="line">        CCS --&gt; |Active|LP1(Call component&#39;s loop)</div>
<div class="line">        CCS --&gt; |NotInitialized|LP2(Call component&#39;s init)</div>
<div class="line">        CCS --&gt; |Initialized|LP3(Call component&#39;s postInit)</div>
<div class="line">        CCS --&gt; |ToRemove|LP4(Remove component)</div>
<div class="line"> </div>
<div class="line">        LP2 --&gt; SCS2(State -&gt; Initialized) --&gt; DF</div>
<div class="line">        LP3 --&gt; SCS3(State -&gt; Active) --&gt; DF</div>
<div class="line">        LP1 --&gt; DF</div>
<div class="line"> </div>
<div class="line">        DF{Success?}</div>
<div class="line">        DF --&gt; |True|X0{{Continue}}</div>
<div class="line">        DF --&gt; |False|X1{{Break}}</div>
<div class="line"> </div>
<div class="line">        LP4 --&gt; Continue</div>
<div class="line">    end</div>
</div><!-- fragment --><ul>
<li>Only one application runs at a time.</li>
<li>Each application manages its own set of components, the framework's core building blocks.</li>
<li>Component states are managed within the application's <code>loop</code> function.</li>
<li>Components implement <code>init</code>, <code>postInit</code>, and <code>loop</code> methods.</li>
<li>Components marked for removal are safely deleted in the next cycle.</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
üìè Utilities</h1>
<p><img src="https://github.com/cziter15/ksIotFrameworkLib/assets/5003708/1b144cdf-e345-4865-8ae7-92f0eaf31992" alt="image" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md6"></a>
üî® Components</h1>
<p><img src="https://github.com/cziter15/ksIotFrameworkLib/assets/5003708/c27aba37-4e54-49f5-9ad5-97439e7baf33" alt="image" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md7"></a>
üîÖ Rules:</h2>
<ul>
<li>Components should be added in the app's <code>init</code> method, so they will be available for <code>postInit</code> methods. (you can add them later, in <code>loop</code> but that's another case)</li>
<li>The <code>init</code> method is the best place to add dependent components, setup initial pin values etc.</li>
<li>The <code>postInit</code> method is the best place to obtain a weak pointer to another component by calling <code>findComponent</code>. This will handle cases when other components were added via <code>init</code> method.</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
üå± Building the Application</h1>
<p>To create an application, define a new class that inherits from <code>ksApplication</code> and add initial components in the <code>init</code> method. Refer to projects like <a href="https://github.com/cziter15/emon_fw"><b>emon_fw</b></a> for a practical example.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
üîé How It Works</h2>
<ul>
<li>The application is instantiated, and its init method is called. If <code>init</code> returns <code>false</code>, the <code>loop</code> method is skipped, and the App Rotator proceeds to instantiate and run the next application in its sequence.</li>
<li>If <code>init</code> returns <code>true</code>, the <code>loop</code> method executes, initializing all components.</li>
<li>In the next iteration, each component‚Äôs <code>postInit</code> method is invoked.</li>
<li>Once initialized, the application enters a continuous loop, calling each component‚Äôs <code>loop</code> method.</li>
<li>If any component‚Äôs <code>loop</code> method returns <code>false</code>, the application terminates, and the App Rotator proceeds to the next application.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> PelletInfo::init()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Add WiFi and MQTT debug components</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksWifiConnector&gt;(PelletInfoConfig::pelletInfoDeviceName);</div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttDebugResponder&gt;();</div>
<div class="line">    addComponent&lt;ksf::comps::ksDevStatMqttReporter&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add OTA updater component</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksDevicePortal&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add state display and receiver components</span></div>
<div class="line">    addComponent&lt;comps::StateDisplay&gt;();</div>
<div class="line">    addComponent&lt;comps::StateReceiver&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add reset button component</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksResetButton&gt;(CFG_PUSH_PIN, LOW);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add MQTT connector component</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttConnector&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialization completed; return true to indicate success</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
üîÅ Application rotator</h1>
<p>The library implements one very useful utility named <code>ksAppRotator</code>. This object can wrap application instantiation logic into something like carousel or rotator.</p>
<p>Typically the device hosts two applications. First application is running core device logic while the second one is dedicated to help the user with the device configuration.</p>
<p>Each application has it's own <code>loop</code> method taking care of all underlying logic. In case of fail (which can happen anytime, even when creating the application object), the rotator will spawn next application and start processing it's logic until fail or break.</p>
<p>This is very flexible, because you can even raise fail (false) from application's <code>init</code> method and then go directly into the configuration mode (for example there's no WiFi credentials provided by the user).</p>
<h1><a class="anchor" id="autotoc_md11"></a>
üî£ Compiler flags</h1>
<ul>
<li>Bare Arduino projects need to have <code>gnu++2a</code> enabled via <code>compiler.cpp.extra_flags=</code> option in the <code>board.txt</code> file.</li>
</ul>
<h1><a class="anchor" id="autotoc_md12"></a>
#Ô∏è‚É£ Custom RTTI</h1>
<ul>
<li>Use the <code>KSF_RTTI_DECLARATIONS</code> macro to provide proper runtime type information generation for proper casting of components.</li>
<li>See <code><a class="el" href="ks_config_provider_8h_source.html">ksConfigProvider.h</a></code> for an example. Your application components should use this macro, otherwise the component finding mechanism won't work.</li>
</ul>
<h1><a class="anchor" id="autotoc_md13"></a>
üî• Saving power</h1>
<ul>
<li>By default, this framework supports enables power saving for the modem.</li>
<li>Automatic modem sleep requires the DTIM to be set on the access point.</li>
<li>The best value for me was 3. It allows the ESP32 to go down from around 100mA to 20mA.</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
üìë Dependencies</h1>
<ul>
<li><b>It is highly recommended to use PlatformIO as it will automatically download dependencies!</b></li>
</ul>
<h2><a class="anchor" id="autotoc_md15"></a>
üî° Frameworks</h2>
<ul>
<li><a href="https://github.com/espressif/arduino-esp32">Arduino for ESP32</a></li>
<li><a href="https://github.com/esp8266/Arduino">Arduino for ESP8266</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md16"></a>
üî° Libraries</h2>
<ul>
<li><a href="https://github.com/knolleary/pubsubclient">PubSubClient</a></li>
<li><a href="https://github.com/Links2004/arduinoWebSockets">arduinoWebSockets</a> </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
