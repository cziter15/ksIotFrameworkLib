<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Doxygen with github: ksIotFrameworkLib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Doxygen with github
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ksIotFrameworkLib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a></p>
<blockquote class="doxtable">
<p>Arduino Library for ESP32/ESP8266 - a composition-oriented Internet of Things framework that provides a simple and extendable architecture, handles device setup (WiFi setup, MQTT and application-specific configuration), network connectivity, MQTT telemetry protocol, and more... </p>
</blockquote>
<p><a href="https://cziter15.github.io/ksIotFrameworkLib"><img src="https://img.shields.io/badge/Doxygen-2C4AA8?logo=doxygen&amp;style=for-the-badge" alt="Read the documentation" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/blob/master/LICENSE"><img src="https://img.shields.io/github/license/cziter15/ksIotFrameworkLib?style=for-the-badge" alt="License" class="inline"/></a></p>
<p><a href="https://app.codacy.com/gh/cziter15/ksIotFrameworkLib/dashboard?utm_source=gh&amp;utm_medium=referral&amp;utm_content=&amp;utm_campaign=Badge_grade"><img src="https://app.codacy.com/project/badge/Grade/956910bb43464108883bdcf57b1f6943" alt="Codacy Badge" class="inline"/></a> <a href="https://hitsofcode.com/github/cziter15/ksIotFrameworkLib/view"><img src="https://hitsofcode.com/github/cziter15/ksIotFrameworkLib" alt="Hits-of-Code" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/commits/master"><img src="https://img.shields.io/github/commit-activity/m/cziter15/ksIotFrameworkLib" alt="Commit activity" class="inline"/></a> <a href="https://platformio.org"><img src="https://img.shields.io/badge/Depends%20on-PlatformIO-orange?logo=platformio" alt="Depends on PlatformIO" class="inline"/></a> <a href="https://github.com/pioarduino"><img src="https://img.shields.io/badge/Depends%20on-PioArduino-orange?logo=pioarduino" alt="Depends on PioArduino" class="inline"/></a></p>
<p><img src="https://github.com/cziter15/ksIotFrameworkLib/assets/5003708/a17e4fe9-144c-4422-be40-90e0f402b054" alt="image" class="inline"/></p>
<blockquote class="doxtable">
<p><b>IMPORTANT</b> <br  />
 This library targets Arduino 3+ on ESP32. However, due to <a href="https://github.com/platformio/platform-espressif32/issues/1225">Platformio statement</a>, it will not automatically pull the latest versions. <br  />
 To use the latest version, set your platform to the pioarduino (by Jason2866) fork in your <code>platformio.ini</code> file: </p><div class="fragment"><div class="line">platform = https://github.com/pioarduino/platform-espressif32.git</div>
</div><!-- fragment --> </blockquote>
<blockquote class="doxtable">
<p><b>IMPORTANT</b> <br  />
 For ESP8266, the latest supported version is based on SDK305. To use it, add <code>-DPIO_FRAMEWORK_ARDUINO_ESPRESSIF_SDK305</code> to your build flags. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md1"></a>
Motivation</h1>
<ul>
<li>The goal of this project is to create a simple template or starting point for developing IoT applications using Espressif microcontrollers.</li>
<li>This project aims to streamline the process of copying and modifying source code for different devices.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Documentation</h1>
<ul>
<li>Detailed documentation can be found <a href="https://cziter15.github.io/ksIotFrameworkLib">here</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Examples</h1>
<ul>
<li>For examples, open the [examples directory](examples).</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Architecture</h1>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    AppState{AppState}</div>
<div class="line">    AppState --&gt; |NotInitialized| Application::Init</div>
<div class="line">    AppState --&gt; |Initialized| Application::Loop</div>
<div class="line"> </div>
<div class="line">    subgraph Application::Init</div>
<div class="line">        A(Add initial components) --&gt; B(Mark app state as initialized)</div>
<div class="line">    end</div>
<div class="line">   </div>
<div class="line">    subgraph Application::Loop</div>
<div class="line">        Loop{{For each component}} --&gt; CCS{State?}</div>
<div class="line"> </div>
<div class="line">        CCS --&gt; |Active|LP1(Call component&#39;s loop)</div>
<div class="line">        CCS --&gt; |NotInitialized|LP2(Call component&#39;s init)</div>
<div class="line">        CCS --&gt; |Initialized|LP3(Call component&#39;s postInit)</div>
<div class="line">        CCS --&gt; |ToRemove|LP4(Remove component)</div>
<div class="line"> </div>
<div class="line">        LP2 --&gt; SCS2(State -&gt; Initialized) --&gt; DF</div>
<div class="line">        LP3 --&gt; SCS3(State -&gt; Active) --&gt; DF</div>
<div class="line">        LP1 --&gt; DF</div>
<div class="line"> </div>
<div class="line">        DF{Success?}</div>
<div class="line">        DF --&gt; |True|X0{{Continue}}</div>
<div class="line">        DF --&gt; |False|X1{{Break}}</div>
<div class="line"> </div>
<div class="line">        LP4 --&gt; Continue</div>
<div class="line">    end</div>
</div><!-- fragment --><ul>
<li>Only one application can be executed simultaneously.</li>
<li>Each application has its own components. Components are a key part of the framework.</li>
<li>Components have states. State change logic is handled in the application's <code>loop</code>.</li>
<li>Each component has <code>init</code>, <code>postInit</code>, and <code>loop</code> methods.</li>
<li>Components can be marked for removal, and they will be safely released in the next tick.</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
üìè Utilities</h1>
<p><img src="https://github.com/cziter15/ksIotFrameworkLib/assets/5003708/1b144cdf-e345-4865-8ae7-92f0eaf31992" alt="image" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md6"></a>
üî® Components</h1>
<p><img src="https://github.com/cziter15/ksIotFrameworkLib/assets/5003708/c27aba37-4e54-49f5-9ad5-97439e7baf33" alt="image" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md7"></a>
üîÖ Rules:</h2>
<ul>
<li>Components should be added in the app's <code>init</code> method, so they will be available for <code>postInit</code> methods. (you can add them later, in <code>loop</code> but that's another case)</li>
<li>The <code>init</code> method is the best place to add dependent components, setup initial pin values etc.</li>
<li>The <code>postInit</code> method is the best place to obtain a weak pointer to another component by calling <code>findComponent</code>. This will handle cases when other components were added via <code>init</code> method.</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
üå± Building the application</h1>
<p>To build an application, simply create a new class inherited from <code>ksApplication</code> and add your initial components inside the <code>init</code> method. See projects like <b>emon_fw</b> for reference.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
üîé How does it work under the hood?</h2>
<ul>
<li>The application is created, followed by the invocation of its <code>init</code> method. If false is returned from the init method, the subsequent execution of the <code>loop</code> will be skipped, resulting in no iteration over the components. The App Rotator will then try to run next apllication.</li>
<li>In case the <code>init</code> method returns true, the application proceeds to execute its <code>loop</code> function. This function traverses through the components, initializing each of them.</li>
<li>In the subsequent iteration, the application triggers the <code>postInit</code> method for each component.</li>
<li>Following this, the application is fully initialized and enters a looping state where it iterates over the components, invoking their respective <code>loop</code> methods.</li>
<li>If any component returns false during it's <code>loop</code> method, the application will break and the App Rotator will select the next application for execution.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> PelletInfo::init()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Create required components (Wifi and Mqtt debug). */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksWifiConnector&gt;(PelletInfoConfig::pelletInfoDeviceName);</div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttDebugResponder&gt;();</div>
<div class="line">    addComponent&lt;ksf::comps::ksDevStatMqttReporter&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create OTA updater component. */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksDevicePortal&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create state display and receiver components. */</span></div>
<div class="line">    addComponent&lt;comps::StateDisplay&gt;();</div>
<div class="line">    addComponent&lt;comps::StateReceiver&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create reset button component. */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksResetButton&gt;(CFG_PUSH_PIN, LOW);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create mqttConnector and statusLed components. */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttConnector&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Application finished initialization, return true as it succedeed. */</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
üîÅ Application rotator</h1>
<p>The library implements one very useful utility named <code>ksAppRotator</code>. This object can wrap application instantiation logic into something like carousel or rotator.</p>
<p>Typically the device hosts two applications. First application is running core device logic while the second one is dedicated to help the user with the device configuration.</p>
<p>Each application has it's own <code>loop</code> method taking care of all underlying logic. In case of fail (which can happen anytime, even when creating the application object), the rotator will spawn next application and start processing it's logic until fail or break.</p>
<p>This is very flexible, because you can even raise fail (false) from application's <code>init</code> method and then go directly into the configuration mode (for example there's no WiFi credentials provided by the user).</p>
<h1><a class="anchor" id="autotoc_md11"></a>
üî£ Compiler flags</h1>
<ul>
<li>Bare Arduino projects need to have <code>gnu++2a</code> enabled via <code>compiler.cpp.extra_flags=</code> option in the <code>board.txt</code> file.</li>
</ul>
<h1><a class="anchor" id="autotoc_md12"></a>
#Ô∏è‚É£ Custom RTTI</h1>
<ul>
<li>Use the <code>KSF_RTTI_DECLARATIONS</code> macro to provide proper runtime type information generation for proper casting of components.</li>
<li>See <code><a class="el" href="ks_config_provider_8h_source.html">ksConfigProvider.h</a></code> for an example. Your application components should use this macro, otherwise the component finding mechanism won't work.</li>
</ul>
<h1><a class="anchor" id="autotoc_md13"></a>
üî• Saving power</h1>
<ul>
<li>By default, this framework supports enables power saving for the modem.</li>
<li>Automatic modem sleep requires the DTIM to be set on the access point.</li>
<li>The best value for me was 3. It allows the ESP32 to go down from around 100mA to 20mA.</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
üìë Dependencies</h1>
<ul>
<li><b>It is highly recommended to use PlatformIO as it will automatically download dependencies!</b></li>
<li><b>Unfortunately PlatformIO is not oficially supporting latest Arduino ports for ESP32, ksIotFrameworkLib is targeting it using pioarduino fork.</b></li>
</ul>
<h2><a class="anchor" id="autotoc_md15"></a>
üî° Frameworks</h2>
<ul>
<li><a href="https://github.com/espressif/arduino-esp32">Arduino for ESP32</a></li>
<li><a href="https://github.com/esp8266/Arduino">Arduino for ESP8266</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md16"></a>
üî° Libraries</h2>
<ul>
<li><a href="https://github.com/knolleary/pubsubclient">PubSubClient</a></li>
<li><a href="https://github.com/Links2004/arduinoWebSockets">arduinoWebSockets</a> </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
