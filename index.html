<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Doxygen with github: ksIotFrameworkLib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Doxygen with github
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ksIotFrameworkLib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a></p>
<blockquote class="doxtable">
<p>&zwj;Arduino Library for ESP32/ESP8266 - a composition-oriented Internet of Things framework that provides a simple and extendable architecture, handles device setup (WiFi setup, MQTT and application-specific configuration), network connectivity, MQTT telemetry protocol, and more... </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md2"></a>
</h1>
<p><a href="https://cziter15.github.io/ksIotFrameworkLib"><img src="https://img.shields.io/badge/Docs%20at-Doxygen-darkblue?style=for-the-badge&amp;labelColor=blue&amp;logo=doxygen" alt="Docs at Doxygen" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/wiki"><img src="https://img.shields.io/badge/Docs%20at-Wiki-darkblue?style=for-the-badge&amp;labelColor=blue&amp;logo=wikidotjs" alt="Docs at Wiki" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib?tab=License-1-ov-file#readme"><img src="https://img.shields.io/badge/License-MIT%20(no%20AI%20training%20allowed)-darkblue?style=for-the-badge&amp;labelColor=blue" alt="License" class="inline"/></a></p>
<p><a href="https://github.com/cziter15/ksIotFrameworkLib/actions/workflows/build-examples.yml"><img src="https://github.com/cziter15/ksIotFrameworkLib/actions/workflows/build-examples.yml/badge.svg" alt="build-examples" style="pointer-events: none;" class="inline"/></a> <a href="https://app.codacy.com/gh/cziter15/ksIotFrameworkLib/dashboard?utm_source=gh&amp;utm_medium=referral&amp;utm_content=&amp;utm_campaign=Badge_grade"><img src="https://app.codacy.com/project/badge/Grade/956910bb43464108883bdcf57b1f6943" alt="Codacy Badge" class="inline"/></a> <a href="https://github.com/cziter15/ksiotframeworklib"><img src="https://img.shields.io/endpoint?color=blue&amp;url=https%3A%2F%2Fghloc.vercel.app%2Fapi%2Fcziter15%2Fksiotframeworklib%2Fbadge%3Ffilter%3D.hpp%24%2C.cpp%24%2C.h%24%26label%3DLines%2520of%2520Code" alt="Lines of Code" class="inline"/></a> <a href="https://platformio.org"><img src="https://img.shields.io/badge/powered%20by-platformio-royalblue?logo=platformio" alt="Powered by platformio" class="inline"/></a> <a href="https://github.com/pioarduino"><img src="https://img.shields.io/badge/powered%20by-pioarduino-royalblue?logo=arduino" alt="Powered by pioarduino" class="inline"/></a></p>
<p><img src="https://github.com/user-attachments/assets/d23e7245-659c-4639-a86e-5ac5bef78a43" alt="image" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md3"></a>
ğŸŒŸ Introduction</h1>
<p><b><code>ksIotFrameworkLib</code></b> is an <b>Arduino-based C++ framework</b> designed for <b>ESP32 and ESP8266</b> microcontrollers. <br  />
</p>
<p>The library handles the typical IoT boilerplate for you, from initial Wi-Fi provisioning via a captive portal to MQTT connectivity with a robust reconnection mechanism. It also includes a built-in LAN-accessible web portal for device configuration, over-the-air firmware updates, live status monitoring, and terminal access. The terminal, a special feature of the web portal, lets you view real-time application logs and define your own commands.</p>
<p>By handling these repetitive foundations, <code>ksIotFrameworkLib</code> lets you concentrate on the unique logic of your smart sensors, controllers, or DIY automations - without needing to reinvent connectivity or configuration layers every time.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
ğŸš€ Potential use cases</h2>
<ul>
<li>Smart home solutions (services, monitoring, alarming)</li>
<li>Telemetry systems (sending sensor data, device statuses)</li>
<li>Remote control applications (switching devices, executing commands)</li>
</ul>
<blockquote class="doxtable">
<p>&zwj;ğŸ’¡ The library is not limited to these examples - itâ€™s designed to support a wide range of IoT projects. For instance, one of my personal implementations involves remotely controlling a heating boiler, fully integrated with Home Assistant via MQTT. I have devices running <b>continuously for months without interruptions</b>, demonstrating the libraryâ€™s stability and reliability in real-world deployments. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md5"></a>
ğŸ“œ Motivation to create the library</h2>
<ul>
<li>Create a <b>solid starting point</b> for developing applications targeting Espressif microcontrollers.</li>
<li><b>Streamline</b> the process of adapting and reusing code across multiple devices.</li>
<li>Apply the <b>DRY principle</b> (Don't Repeat Yourself) to DIY IoT projects by consolidating common functionality into a simple, reusable library.</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
ğŸ“š Documentation</h2>
<ul>
<li>Detailed documentation can be found <a href="https://cziter15.github.io/ksIotFrameworkLib">here</a>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
ğŸ“Ÿ Examples</h2>
<ul>
<li>For examples, refer to the <a href="https://github.com/cziter15/ksIotFrameworkLib/tree/master/examples">examples directory</a>.</li>
</ul>
<hr  />
<blockquote class="doxtable">
<p>&zwj;<b>IMPORTANT FOR ESP32</b></p>
<p>This library targets Arduino 3+ on ESP32. Due to <a href="https://github.com/platformio/platform-espressif32/issues/1225">PlatformIO limitations</a>, it does not automatically fetch the latest versions. Use the pioarduino fork by Jason2866 in your <code>platformio.ini</code> file: </p><div class="fragment"><div class="line">platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip</div>
</div><!-- fragment --><p><b>IMPORTANT FOR ESP8266</b></p>
<p>For ESP8266, the latest supported version is based on SDK305. To use it, please add this build flag:</p>
<div class="fragment"><div class="line">DPIO_FRAMEWORK_ARDUINO_ESPRESSIF_SDK305</div>
</div><!-- fragment --> </blockquote>
<h1><a class="anchor" id="autotoc_md9"></a>
</h1>
<h2><a class="anchor" id="autotoc_md10"></a>
ğŸ› ï¸ Architecture</h2>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line"> subgraph Application_Init[&quot;Application_Init&quot;]</div>
<div class="line">        B(&quot;Mark app state as initialized&quot;)</div>
<div class="line">        A(&quot;Add initial components&quot;)</div>
<div class="line">  end</div>
<div class="line"> subgraph Application_Loop[&quot;Application_Loop&quot;]</div>
<div class="line">        CCS{&quot;State?&quot;}</div>
<div class="line">        Loop{{&quot;For each component&quot;}}</div>
<div class="line">        LP1@{ label: &quot;Call component&#39;s loop&quot; }</div>
<div class="line">        LP2@{ label: &quot;Call component&#39;s init&quot; }</div>
<div class="line">        LP3@{ label: &quot;Call component&#39;s postInit&quot; }</div>
<div class="line">        LP4(&quot;Remove component&quot;)</div>
<div class="line">        DF{&quot;Success?&quot;}</div>
<div class="line">        SCS2(&quot;State -&gt; Initialized&quot;)</div>
<div class="line">        SCS3(&quot;State -&gt; Active&quot;)</div>
<div class="line">        X0{{&quot;Continue&quot;}}</div>
<div class="line">        X1{{&quot;Break&quot;}}</div>
<div class="line">        Continue[&quot;Continue&quot;]</div>
<div class="line">  end</div>
<div class="line">    AppState{&quot;AppState&quot;} -- NotInitialized --&gt; Application_Init</div>
<div class="line">    AppState -- Initialized --&gt; Application_Loop</div>
<div class="line">    A --&gt; B</div>
<div class="line">    Loop --&gt; CCS</div>
<div class="line">    CCS -- Active --&gt; LP1</div>
<div class="line">    CCS -- NotInitialized --&gt; LP2</div>
<div class="line">    CCS -- Initialized --&gt; LP3</div>
<div class="line">    CCS -- ToRemove --&gt; LP4</div>
<div class="line">    LP2 --&gt; SCS2</div>
<div class="line">    SCS2 --&gt; DF</div>
<div class="line">    LP3 --&gt; SCS3</div>
<div class="line">    SCS3 --&gt; DF</div>
<div class="line">    LP1 --&gt; DF</div>
<div class="line">    DF -- True --&gt; X0</div>
<div class="line">    DF -- False --&gt; X1</div>
<div class="line">    LP4 --&gt; Continue</div>
<div class="line">    LP1@{ shape: rounded}</div>
<div class="line">    LP2@{ shape: rounded}</div>
<div class="line">    LP3@{ shape: rounded}</div>
</div><!-- fragment --><ul>
<li>Only one application runs at a time.</li>
<li>Each application manages its own set of components, the framework's core building blocks.</li>
<li>Component states are managed within the application's <code>loop</code> function.</li>
<li>Components implement <code>init</code>, <code>postInit</code>, and <code>loop</code> methods.</li>
<li>Components marked for removal are safely deleted in the next cycle.</li>
</ul>
<h3><a class="anchor" id="autotoc_md11"></a>
ğŸ“ Utilities and components structure</h3>
<div class="fragment"><div class="line">ğŸ“ ksf</div>
<div class="line">â”œâ”€â”€ ğŸ“„ ksAppRotator                 â”€â”€â”€ Application rotator component</div>
<div class="line">â”œâ”€â”€ ğŸ“„ ksRtti                       â”€â”€â”€ Implements RTTI (run-time type information) for objects</div>
<div class="line">â”œâ”€â”€ ğŸ“„ ksComponent                  â”€â”€â”€ Base component class</div>
<div class="line">â”œâ”€â”€ ğŸ“„ ksConstants                  â”€â”€â”€ Basic low-level definitions</div>
<div class="line">â”œâ”€â”€ ğŸ“‚ misc</div>
<div class="line">â”‚   â”œâ”€â”€ ğŸ“„ ksCertUtils              â”€â”€â”€ MQTT certificate utilities</div>
<div class="line">â”‚   â”œâ”€â”€ ğŸ“„ ksConfig                 â”€â”€â”€ Configuration file handling</div>
<div class="line">â”‚   â”œâ”€â”€ ğŸ“„ ksDomainQuery            â”€â”€â”€ Custom DNS implementation</div>
<div class="line">â”‚   â”œâ”€â”€ ğŸ“„ ksSimpleTimer            â”€â”€â”€ Simple timer functionality</div>
<div class="line">â”‚   â””â”€â”€ ğŸ“„ ksWSServer               â”€â”€â”€ Internal WS handling for device portal</div>
<div class="line">â””â”€â”€ ğŸ“‚ comps</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksConfigProvider         â”€â”€â”€ Manages configuration parameters and storage</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksDevStatMqttReporter    â”€â”€â”€ Sends periodic device status updates via MQTT</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksDevicePortal           â”€â”€â”€ Implements a web-based configuration portal</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksLed                    â”€â”€â”€ Simplifies LED control</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksMqttConfigProvider     â”€â”€â”€ Manages MQTT-related configuration</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksMqttConnector          â”€â”€â”€ Handles MQTT connection management</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksResetButton            â”€â”€â”€ Implements reset button functionality</div>
<div class="line">    â”œâ”€â”€ ğŸ“„ ksWifiConfigurator       â”€â”€â”€ Handles WiFi configuration setup</div>
<div class="line">    â””â”€â”€ ğŸ“„ ksWifiConnector          â”€â”€â”€ Manages WiFi connection</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md12"></a>
ğŸ”… Rules</h3>
<ul>
<li>Components should be added in the app's <code>init</code> method, so they will be available for <code>postInit</code> methods. (you can anytime later, from the <code>loop</code> but please treat it like exceptional case)</li>
<li>The <code>init</code> method is the best place to add dependent components, setup initial pin values etc.</li>
<li>The <code>postInit</code> method is the best place to obtain a weak pointer to another component by calling <code>findComponent</code>. This will handle cases when other components were added via <code>init</code> method.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md14"></a>
ğŸŒ± Building the Application</h2>
<p>To create an application, define a new class that inherits from <code>ksApplication</code> and add initial components in the <code>init</code> method. Refer to projects like <a href="https://github.com/cziter15/emon_fw"><b>emon_fw</b></a> for a practical example.</p>
<h3><a class="anchor" id="autotoc_md15"></a>
ğŸ” How It Works</h3>
<ul>
<li>The application is instantiated, and its <code>init</code> method is called. If <code>init</code> returns <code>false</code>, the <code>loop</code> method is skipped, and the App Rotator proceeds to instantiate and run the next application in its sequence.</li>
<li>If <code>init</code> returns <code>true</code>, the <code>loop</code> method executes, initializing all components.</li>
<li>In the next iteration, each componentâ€™s <code>postInit</code> method is invoked.</li>
<li>Once initialized, the application enters a continuous loop, calling each componentâ€™s <code>loop</code> method.</li>
<li>If any componentâ€™s <code>loop</code> method returns <code>false</code>, the application terminates, and the App Rotator proceeds to the next application.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> PelletInfo::init()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Add WiFi and MQTT debug components</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksWifiConnector&gt;(PelletInfoConfig::pelletInfoDeviceName);</div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttDebugResponder&gt;();</div>
<div class="line">    addComponent&lt;ksf::comps::ksDevStatMqttReporter&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add OTA updater component</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksDevicePortal&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add state display and receiver components</span></div>
<div class="line">    addComponent&lt;comps::StateDisplay&gt;();</div>
<div class="line">    addComponent&lt;comps::StateReceiver&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add reset button component</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksResetButton&gt;(CFG_PUSH_PIN, LOW);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add MQTT connector component</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttConnector&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialization completed; return true to indicate success</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md17"></a>
ğŸ” Application rotator</h2>
<p>The library provides a very useful utility called <code>ksAppRotator</code>. This object can wrap application instantiation logic into a carousel-like rotation mechanism.</p>
<p>Typically, a device hosts two applications:</p>
<ul>
<li>Core application - Runs the core device logic.</li>
<li>Configuration assistant - Assists the user with device configuration.</li>
</ul>
<p>Each application implements its own <code>loop()</code> method to manage its logic. In case of a failure at any point (including during the applicationâ€™s construction), the rotator will seamlessly switch to the next application and begin executing its logic.</p>
<p>This design is highly flexible. For example, you can trigger a failure (<code>return false</code>) during an applicationâ€™s <code>init()</code> method, allowing the system to immediately switch into configuration mode if conditions require it (e.g. missing WiFi credentials).</p>
<hr  />
<h2><a class="anchor" id="autotoc_md19"></a>
ğŸ§© Miscellaneous</h2>
<h3><a class="anchor" id="autotoc_md20"></a>
ğŸ”£ Compiler flags / Custom RTTI</h3>
<ul>
<li>Bare Arduino projects need to have <code>gnu++2a</code> enabled via <code>compiler.cpp.extra_flags=</code> option in the <code>board.txt</code> file.</li>
<li>Use the <code>KSF_RTTI_DECLARATIONS</code> macro to provide proper runtime type information generation for proper casting of components.</li>
<li>See <code><a class="el" href="ks_config_provider_8h_source.html">ksConfigProvider.h</a></code> for an example. Your application components should use this macro, otherwise the component finding mechanism won't work.</li>
</ul>
<h3><a class="anchor" id="autotoc_md21"></a>
ğŸ”¥ Saving power</h3>
<ul>
<li>Modem sleep is enabled by default and can be controlled as an optional parameter in the <code>ksWifiConnector</code> constructor.</li>
<li>Automatic modem sleep requires the DTIM <em>(Delivery Traffic Indication Message)</em> to be correctly set on the access point.</li>
<li>The best value for me was <code>3</code>. It allows the ESP32 to go down from around 100mA to 20mA.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md23"></a>
ğŸ“‘ Dependencies</h2>
<ul>
<li><b>It is highly recommended to use PlatformIO as it will automatically download dependencies!</b></li>
</ul>
<h3><a class="anchor" id="autotoc_md24"></a>
ğŸ”¡ Frameworks</h3>
<ul>
<li><a href="https://github.com/espressif/arduino-esp32">Arduino for ESP32</a></li>
<li><a href="https://github.com/esp8266/Arduino">Arduino for ESP8266</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md25"></a>
ğŸ”¡ Libraries</h3>
<ul>
<li><a href="https://github.com/cziter15/pubsubclient3">PubSubClient</a> originally developed by @hmueller01 and @knolleary</li>
<li><a href="https://github.com/cziter15/arduinoWebSockets">arduinoWebSockets</a> originally developed by @Links2004 </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
