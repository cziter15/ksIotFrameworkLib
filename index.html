<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Doxygen with github: ksIotFrameworkLib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Doxygen with github
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ksIotFrameworkLib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a><a href="https://platformio.org"><img src="https://img.shields.io/badge/works%20best%20with-PlatformIO-orange?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMjUwMCIgaGVpZ2h0PSIyNTAwIiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCI+PHBhdGggZD0iTTEyOCAwQzkzLjgxIDAgNjEuNjY2IDEzLjMxNCAzNy40OSAzNy40OSAxMy4zMTQgNjEuNjY2IDAgOTMuODEgMCAxMjhjMCAzNC4xOSAxMy4zMTQgNjYuMzM0IDM3LjQ5IDkwLjUxQzYxLjY2NiAyNDIuNjg2IDkzLjgxIDI1NiAxMjggMjU2YzM0LjE5IDAgNjYuMzM0LTEzLjMxNCA5MC41MS0zNy40OUMyNDIuNjg2IDE5NC4zMzQgMjU2IDE2Mi4xOSAyNTYgMTI4YzAtMzQuMTktMTMuMzE0LTY2LjMzNC0zNy40OS05MC41MUMxOTQuMzM0IDEzLjMxNCAxNjIuMTkgMCAxMjggMCIgZmlsbD0iI0ZGN0YwMCIvPjxwYXRoIGQ9Ik0yNDkuMzg2IDEyOGMwIDY3LjA0LTU0LjM0NyAxMjEuMzg2LTEyMS4zODYgMTIxLjM4NkM2MC45NiAyNDkuMzg2IDYuNjEzIDE5NS4wNCA2LjYxMyAxMjggNi42MTMgNjAuOTYgNjAuOTYgNi42MTQgMTI4IDYuNjE0YzY3LjA0IDAgMTIxLjM4NiA1NC4zNDYgMTIxLjM4NiAxMjEuMzg2IiBmaWxsPSIjRkZGIi8+PHBhdGggZD0iTTE2MC44NjkgNzQuMDYybDUuMTQ1LTE4LjUzN2M1LjI2NC0uNDcgOS4zOTItNC44ODYgOS4zOTItMTAuMjczIDAtNS43LTQuNjItMTAuMzItMTAuMzItMTAuMzJzLTEwLjMyIDQuNjItMTAuMzIgMTAuMzJjMCAzLjc1NSAyLjAxMyA3LjAzIDUuMDEgOC44MzdsLTUuMDUgMTguMTk1Yy0xNC40MzctMy42Ny0yNi42MjUtMy4zOS0yNi42MjUtMy4zOWwtMi4yNTggMS4wMXYxNDAuODcybDIuMjU4Ljc1M2MxMy42MTQgMCA3My4xNzctNDEuMTMzIDczLjMyMy04NS4yNyAwLTMxLjYyNC0yMS4wMjMtNDUuODI1LTQwLjU1NS01Mi4xOTd6TTE0Ni41MyAxNjQuOGMtMTEuNjE3LTE4LjU1Ny02LjcwNi02MS43NTEgMjMuNjQzLTY3LjkyNSA4LjMyLTEuMzMzIDE4LjUwOSA0LjEzNCAyMS41MSAxNi4yNzkgNy41ODIgMjUuNzY2LTM3LjAxNSA2MS44NDUtNDUuMTUzIDUxLjY0NnptMTguMjE2LTM5Ljc1MmE5LjM5OSA5LjM5OSAwIDAgMC05LjM5OSA5LjM5OSA5LjM5OSA5LjM5OSAwIDAgMCA5LjQgOS4zOTkgOS4zOTkgOS4zOTkgMCAwIDAgOS4zOTgtOS40IDkuMzk5IDkuMzk5IDAgMCAwLTkuMzk5LTkuMzk4em0yLjgxIDguNjcyYTIuMzc0IDIuMzc0IDAgMSAxIDAtNC43NDkgMi4zNzQgMi4zNzQgMCAwIDEgMCA0Ljc0OXoiIGZpbGw9IiNFNTcyMDAiLz48cGF0aCBkPSJNMTAxLjM3MSA3Mi43MDlsLTUuMDIzLTE4LjkwMWMyLjg3NC0xLjgzMiA0Ljc4Ni01LjA0IDQuNzg2LTguNzAxIDAtNS43LTQuNjItMTAuMzItMTAuMzItMTAuMzItNS42OTkgMC0xMC4zMTkgNC42Mi0xMC4zMTkgMTAuMzIgMCA1LjY4MiA0LjU5MiAxMC4yODkgMTAuMjY3IDEwLjMxN0w5NS44IDc0LjM3OGMtMTkuNjA5IDYuNTEtNDAuODg1IDIwLjc0Mi00MC44ODUgNTEuODguNDM2IDQ1LjAxIDU5LjU3MiA4NS4yNjcgNzMuMTg2IDg1LjI2N1Y2OC44OTJzLTEyLjI1Mi0uMDYyLTI2LjcyOSAzLjgxN3ptMTAuMzk1IDkyLjA5Yy04LjEzOCAxMC4yLTUyLjczNS0yNS44OC00NS4xNTQtNTEuNjQ1IDMuMDAyLTEyLjE0NSAxMy4xOS0xNy42MTIgMjEuNTExLTE2LjI4IDMwLjM1IDYuMTc1IDM1LjI2IDQ5LjM2OSAyMy42NDMgNjcuOTI2em0tMTguODItMzkuNDZhOS4zOTkgOS4zOTkgMCAwIDAtOS4zOTkgOS4zOTggOS4zOTkgOS4zOTkgMCAwIDAgOS40IDkuNCA5LjM5OSA5LjM5OSAwIDAgMCA5LjM5OC05LjQgOS4zOTkgOS4zOTkgMCAwIDAtOS4zOTktOS4zOTl6bS0yLjgxIDguNjcxYTIuMzc0IDIuMzc0IDAgMSAxIDAtNC43NDggMi4zNzQgMi4zNzQgMCAwIDEgMCA0Ljc0OHoiIGZpbGw9IiNGRjdGMDAiLz48L3N2Zz4=" alt="Build for PlatformIO" class="inline"/></a> <a href="https://hitsofcode.com/github/cziter15/ksIotFrameworkLib/view"><img src="https://hitsofcode.com/github/cziter15/ksIotFrameworkLib" alt="Hits-of-Code" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/commits/master"><img src="https://img.shields.io/github/commit-activity/m/cziter15/ksIotFrameworkLib" alt="Commit activity" class="inline"/></a> <a href="https://github.com/cziter15/ksIotFrameworkLib/blob/master/LICENSE"><img src="https://img.shields.io/github/license/cziter15/ksIotFrameworkLib" alt="License" class="inline"/></a></p>
<p align="center"></p>
<p><img src="doc/header.jpg" alt="" class="inline"/> </p>
<h1><a class="anchor" id="autotoc_md1"></a>
What and why?</h1>
<p>The goal of this project is to create a simple template or starting point for developing Internet of Things (IoT) applications using the ESP 8266/32 microcontroller. I noticed that I was frequently copying and modifying existing applications when creating new ones for different devices, and I wanted to streamline this process. This project aims to do just that by providing a more organized approach to starting new IoT projects with the ESP 8266/32.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Architecture</h1>
<div class="fragment"><div class="line">flowchart TD</div>
<div class="line">    AppState{AppState}</div>
<div class="line">    AppState --&gt; |NotInitialized| Application::Init</div>
<div class="line">    AppState --&gt; |Initialized| Application::Loop</div>
<div class="line"> </div>
<div class="line">    subgraph Application::Init</div>
<div class="line">        A(Add initial components) --&gt;</div>
<div class="line">    B(Mark app state as initialized)</div>
<div class="line">    end</div>
<div class="line">   </div>
<div class="line">    subgraph Application::Loop</div>
<div class="line">        Loop{{For each component}} --&gt; CCS{State?}</div>
<div class="line"> </div>
<div class="line">        CCS --&gt; |Looping|LP1(Call component&#39;s loop)</div>
<div class="line">        CCS --&gt; |NotInitialized|LP2(Call component&#39;s init)</div>
<div class="line">        CCS --&gt; |Initialized|LP3(Call component&#39;s postInit)</div>
<div class="line">        CCS --&gt; |ToBeRemoved|LP4(Remove component)</div>
<div class="line"> </div>
<div class="line">    LP2 --&gt; SCS2(State -&gt; Initialized) --&gt; DF</div>
<div class="line">    LP3 --&gt; SCS3(State -&gt; Looping) --&gt; DF</div>
<div class="line">    LP1 --&gt; DF</div>
<div class="line"> </div>
<div class="line">        DF{Success?}</div>
<div class="line">        DF --&gt; |True|X0{{Continue}}</div>
<div class="line">        DF --&gt; |False|X1{{Break}}</div>
<div class="line"> </div>
<div class="line">    LP4 --&gt; Continue</div>
<div class="line">    end</div>
</div><!-- fragment --><ul>
<li>Only one application can be executed simultaneously.</li>
<li>Each application has its own components. Components are a key part of the framework.</li>
<li>Components have states. State change logic is handled in the application's loop.</li>
<li>Each component has init, postInit, and loop methods.</li>
<li>Components can be marked for removal, and they will be safely released in the next tick.</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Utilities</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Utility   </th><th class="markdownTableHeadNone">Function    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ksEvent   </td><td class="markdownTableBodyNone">Provides a simple event broadcasting system. Used for MQTT events, etc.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ksSimpleTimer   </td><td class="markdownTableBodyNone">A very simple "timer" mechanism. In the triggered() method, it calculates and checks if the specified interval has just passed.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md4"></a>
Components</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Component   </th><th class="markdownTableHeadNone">Function    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ksConfigProvider   </td><td class="markdownTableBodyNone">Used to manage parameters. The configurator component calls each config provider to handle parameter injection/capture during the WiFi configuration stage.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ksLed   </td><td class="markdownTableBodyNone">Used to control diodes, including blinking, turning off, and turning on.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ksMqttConfigProvider   </td><td class="markdownTableBodyNone">Used to manage MQTT parameters (broker, password, prefix, etc.).    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ksMqttConnector   </td><td class="markdownTableBodyNone">Used to maintain a connection with MQTT. The user can bind to the onMessage and onConnected events.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ksDevStatMqttReporter   </td><td class="markdownTableBodyNone">Reports device state periodically to the MQTT broker to the 'dstat' sub-topic.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ksDevicePortal   </td><td class="markdownTableBodyNone">Handles all-in-one things like configuration, debug and OTA updates.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ksResetButton   </td><td class="markdownTableBodyNone">Used to exit the app loop or reset the entire device (to trigger the config portal).    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ksWiFiConfigurator   </td><td class="markdownTableBodyNone">The base WiFi configurator component, providing WiFi management portal and allowing config providers to inject and capture parameters.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ksWiFiConnector   </td><td class="markdownTableBodyNone">Manages WiFi connection (triggers events, handles reconnection etc.).   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md5"></a>
Rules:</h2>
<ul>
<li>Components should be added in the app's <b>init</b> method, so they will be available for <b>postInit</b> methods. (you can add them later, in loop() but that's another case)</li>
<li>The <b>init</b> method is the best place to add dependent components, setup initial pin values etc.</li>
<li>The <b>postInit</b> method is the best place to obtain a weak pointer to another component by calling <b>findComponent</b>. This will handle cases when other components were added via init method.</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
Building application</h1>
<p>To build an application, simply create a new class inherited from ksApplication and add your initial components inside the init method. See projects like <b>emon_fw</b> for reference.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
How does it work under the hood?</h2>
<ul>
<li>The application is created, followed by the invocation of its init() method. If false is returned from the init method, the subsequent execution of the loop will be skipped, resulting in no iteration over the components. The App Rotator will then try to run next apllication.</li>
<li>In case the init() method returns true, the application proceeds to execute its loop() function. This function traverses through the components, initializing each of them.</li>
<li>In the subsequent iteration, the application triggers the postInitialize() method for each component.</li>
<li>Following this, the application is fully initialized and enters a looping state where it iterates over the components, invoking their respective loop methods.</li>
<li>If any component returns false during it's loop method, the application will break and the App Rotator will select the next application for execution.</li>
</ul>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordtype">bool</span> PelletInfo::init()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Create required components (Wifi and Mqtt debug). */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksWifiConnector&gt;(PelletInfoConfig::pelletInfoDeviceName);</div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttDebugResponder&gt;();</div>
<div class="line">    addComponent&lt;ksf::comps::ksDevStatMqttReporter&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create OTA updater component. */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksDevicePortal&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create state display and receiver components. */</span></div>
<div class="line">    addComponent&lt;comps::StateDisplay&gt;();</div>
<div class="line">    addComponent&lt;comps::StateReceiver&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create reset button component. */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksResetButton&gt;(CFG_PUSH_PIN, LOW);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create mqttConnector and statusLed components. */</span></div>
<div class="line">    addComponent&lt;ksf::comps::ksMqttConnector&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Application finished initialization, return true as it succedeed. */</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Compiler flags</h1>
<p>Bare Arduino projects need to have C++17 enabled via <code>compiler.cpp.extra_flags=</code> option in the board.txt file.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Custom RTTI</h1>
<p>Use the KSF_RTTI_DECLARATIONS macro to provide proper runtime type information generation for proper casting of components. See <a class="el" href="ks_config_provider_8h_source.html">ksConfigProvider.h</a> for an example. Your application components should use this macro, otherwise the component finding mechanism won't work.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Saving power</h1>
<p>By default, this framework supports power saving for the modem. This requires the DTIM to be set on the access point. The best value for me is 3. It allows the ESP32 to go down from around 100mA to 20mA.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Dependencies</h1>
<p><b>It is highly recommended to use PlatformIO as it will automatically download dependencies!</b></p>
<h2><a class="anchor" id="autotoc_md12"></a>
Frameworks</h2>
<ul>
<li>Arduino for ESP32 [ <a href="https://github.com/espressif/arduino-esp32">https://github.com/espressif/arduino-esp32</a> ]</li>
<li>Arduino for ESP8266 [ <a href="https://github.com/esp8266/Arduino">https://github.com/esp8266/Arduino</a> ]</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Libraries</h2>
<ul>
<li>PubSubClient [ <a href="https://github.com/knolleary/pubsubclient">https://github.com/knolleary/pubsubclient</a> ]</li>
<li>arduinoWebSockets [ <a href="https://github.com/Links2004/arduinoWebSockets">https://github.com/Links2004/arduinoWebSockets</a> ]</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Donate</h1>
<p>Feel free to support development (of course optionally) :)</p>
<p><a href="https://www.paypal.com/donate/?hosted_button_id=A3QTXX6MN9LN8">&lt;img src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif"&gt;</a> </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
